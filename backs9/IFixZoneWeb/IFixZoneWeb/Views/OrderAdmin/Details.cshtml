@model IFixZoneWeb.Models.Entities.Order
@{
    Layout = "_AdminLayout";  // <-- QUAN TRỌNG: Dòng này phải có để dùng layout admin
}
@{
    ViewData["Title"] = $"Chi tiết đơn hàng #{Model.OrderCode}";
}

<div class="container-fluid py-5">
    <h2 class="mb-4 text-center text-md-start fw-bold">Chi tiết đơn hàng #@Model.OrderCode</h2>

    <div class="row g-4">
        <!-- Thông tin người nhận -->
        <div class="col-md-6">
            <div class="card border-info shadow-sm h-100">
                <div class="card-header bg-info text-white">
                    <h5 class="mb-0"><i class="fa-solid fa-user me-2"></i>Thông tin người nhận</h5>
                </div>
                <div class="card-body">
                    <p class="mb-2"><strong>Tên:</strong> @Model.RecipientName</p>
                    <p class="mb-2"><strong>SĐT:</strong> @Model.RecipientPhone</p>
                    <p class="mb-2"><strong>Địa chỉ:</strong> @Model.RecipientAddress</p>
                    <p class="mb-0"><strong>Ngày đặt:</strong> @(Model.OrderDate?.ToString("dd/MM/yyyy HH:mm") ?? "N/A")</p>
                </div>
            </div>
        </div>

        <!-- Trạng thái hiện tại & Cập nhật + In đơn -->
        <div class="col-md-6">
            <div class="card border-primary shadow-sm h-100">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0"><i class="fa-solid fa-tasks me-2"></i>Trạng thái đơn hàng</h5>
                </div>
                <div class="card-body">
                    <p class="mb-3">
                        <strong>Hiện tại:</strong>
                        <span class="badge bg-@GetStatusColor(Model.Status) fs-5 px-4 py-2">@Model.Status</span>
                    </p>

                    <!-- Form cập nhật trạng thái -->
                    <form asp-action="UpdateStatus" method="post" class="d-grid gap-3">
                        <input type="hidden" name="id" value="@Model.OrderId" />
                        <div class="input-group">
                            <select name="newStatus" class="form-select form-select-lg">
                                @foreach (var status in new[] { "Mới", "Xác nhận", "Đang chuẩn bị", "Đang giao", "Hoàn thành", "Hủy" })
                                {
                                    <option value="@status" selected="@(status == Model.Status)">@status</option>
                                }
                            </select>
                            <button type="submit" class="btn btn-success btn-lg">
                                <i class="fa-solid fa-sync-alt me-2"></i>Cập nhật
                            </button>
                        </div>
                    </form>

                    <!-- Nút In đơn hàng (ngay dưới nút cập nhật) -->
                    <div class="d-grid mt-3">
                        <a asp-action="Print" asp-route-id="@Model.OrderId" target="_blank" class="btn btn-outline-success btn-lg">
                            <i class="fa-solid fa-print me-2"></i>In đơn hàng
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Sản phẩm trong đơn -->
    <div class="card mt-4 shadow-sm">
        <div class="card-header bg-success text-white">
            <h5 class="mb-0"><i class="fa-solid fa-box me-2"></i>Sản phẩm trong đơn (@Model.OrderDetails.Count sản phẩm)</h5>
        </div>
        <div class="card-body p-0">
            <div class="table-responsive">
                <table class="table table-striped table-hover mb-0 align-middle">
                    <thead class="table-dark">
                        <tr>
                            <th>Sản phẩm</th>
                            <th class="text-end">Đơn giá</th>
                            <th class="text-center">Số lượng</th>
                            <th class="text-end">Thành tiền</th>
                        </tr>
                    </thead>
                    <tbody>
                        @foreach (var item in Model.OrderDetails)
                        {
                            <tr>
                                <td>@item.Product?.ProductName</td>
                                <td class="text-end">@item.UnitPrice.ToString("N0") ₫</td>
                                <td class="text-center fw-bold">@item.Quantity</td>
                                <td class="text-end fw-bold text-danger">@((item.Quantity * item.UnitPrice).ToString("N0")) ₫</td>
                            </tr>
                        }
                    </tbody>
                    <tfoot>
                        <tr class="table-active fw-bold">
                            <td colspan="3" class="text-end fs-5">Tổng cộng:</td>
                            <td class="text-end fs-4 text-danger">@(Model.TotalAmount?.ToString("N0") ?? "0") ₫</td>
                        </tr>
                    </tfoot>
                </table>
            </div>
        </div>
    </div>

    <!-- Lịch sử trạng thái -->
    @if (Model.OrderStatusHistories?.Any() == true)
    {
        <div class="card mt-4 shadow-sm">
            <div class="card-header bg-secondary text-white">
                <h5 class="mb-0"><i class="fa-solid fa-history me-2"></i>Lịch sử thay đổi trạng thái</h5>
            </div>
            <div class="card-body">
                <ul class="list-group list-group-flush">
                    @foreach (var history in Model.OrderStatusHistories.OrderByDescending(h => h.UpdatedAt))
                    {
                        <li class="list-group-item d-flex justify-content-between align-items-center">
                            <strong>@history.Status</strong>
                            <small class="text-muted">
                                @(history.UpdatedAt?.ToString("dd/MM/yyyy HH:mm") ?? "N/A")
                            </small>
                        </li>
                    }
                </ul>
            </div>
        </div>
    }

    <div class="text-center mt-5">
        <a asp-action="Index" class="btn btn-secondary btn-lg px-5">
            <i class="fa-solid fa-arrow-left me-2"></i>Quay lại danh sách đơn hàng
        </a>
    </div>
</div>

@functions {
    string GetStatusColor(string? status) => status switch
    {
        "Mới" => "primary",
        "Xác nhận" => "info",
        "Đang chuẩn bị" => "warning",
        "Đang giao" => "secondary",
        "Hoàn thành" => "success",
        "Hủy" => "danger",
        _ => "secondary"
    };
}

<style>
    /* Ẩn nút và phần thừa khi in */
    @@media print {
        .no-print {
            display: none !important;
        }

        body {
            background: white !important;
            padding: 20px;
        }

        .card {
            border: none;
            box-shadow: none;
            margin-bottom: 20px;
        }

        .table {
            font-size: 12pt;
        }

        .text-danger {
            color: #dc3545 !important;
        }

        h2, h5 {
            color: black !important;
        }

        @@page {
            margin: 1cm;
            size: A4 portrait;
        }
    }
</style>