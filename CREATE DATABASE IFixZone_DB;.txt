CREATE DATABASE IFixZone_DB;
GO
USE IFixZone_DB;
GO


/* ==========================
   ROLES & AUTHENTICATION
========================== */

CREATE TABLE Roles (
    RoleID INT IDENTITY PRIMARY KEY,
    RoleName NVARCHAR(50) NOT NULL UNIQUE   -- Admin / Staff / Customer
);

INSERT INTO Roles(RoleName)
VALUES (N'Admin'), (N'Staff'), (N'Customer');


CREATE TABLE Users (
    UserID INT IDENTITY PRIMARY KEY,
    Username NVARCHAR(50) NOT NULL UNIQUE,
    PasswordHash NVARCHAR(255) NOT NULL,
    FullName NVARCHAR(100),
    Email NVARCHAR(100),
    Phone NVARCHAR(20),
    Address NVARCHAR(255),
    CreatedAt DATETIME DEFAULT GETDATE(),
    IsActive BIT DEFAULT 1
);

-- Bảng gán quyền (1 user có thể nhiều role)
CREATE TABLE UserRoles (
    UserID INT NOT NULL,
    RoleID INT NOT NULL,
    CONSTRAINT PK_UserRoles PRIMARY KEY(UserID, RoleID),
    FOREIGN KEY (UserID) REFERENCES Users(UserID),
    FOREIGN KEY (RoleID) REFERENCES Roles(RoleID)
);



/* ==========================
   PRODUCT CATALOG
========================== */

CREATE TABLE Categories (
    CategoryID INT IDENTITY PRIMARY KEY,
    CategoryName NVARCHAR(100) NOT NULL,
    ParentID INT NULL
);

CREATE TABLE Products (
    ProductID INT IDENTITY PRIMARY KEY,
    ProductName NVARCHAR(200) NOT NULL,
    CategoryID INT NOT NULL,
    Price DECIMAL(18,2) NOT NULL,
    Stock INT DEFAULT 0,
    Status NVARCHAR(20) DEFAULT N'Active',
    MainImage NVARCHAR(255),
    Description NVARCHAR(MAX),
    CreatedAt DATETIME DEFAULT GETDATE(),
    FOREIGN KEY (CategoryID) REFERENCES Categories(CategoryID)
);

CREATE TABLE ProductSpecifications (
    SpecID INT IDENTITY PRIMARY KEY,
    ProductID INT NOT NULL,
    SpecName NVARCHAR(100),
    SpecValue NVARCHAR(255),
    FOREIGN KEY (ProductID) REFERENCES Products(ProductID)
);



/* ==========================
   CART
========================== */

CREATE TABLE Carts (
    CartID INT IDENTITY PRIMARY KEY,
    UserID INT NOT NULL,
    CreatedAt DATETIME DEFAULT GETDATE(),
    FOREIGN KEY (UserID) REFERENCES Users(UserID)
);

CREATE TABLE CartItems (
    CartItemID INT IDENTITY PRIMARY KEY,
    CartID INT NOT NULL,
    ProductID INT NOT NULL,
    Quantity INT NOT NULL,
    FOREIGN KEY (CartID) REFERENCES Carts(CartID),
    FOREIGN KEY (ProductID) REFERENCES Products(ProductID)
);



/* ==========================
   ORDERS
========================== */

CREATE TABLE Orders (
    OrderID INT IDENTITY PRIMARY KEY,
    OrderCode NVARCHAR(20),
    UserID INT NOT NULL,
    TotalAmount DECIMAL(18,2),
    Status NVARCHAR(30) DEFAULT N'Mới',
    OrderDate DATETIME DEFAULT GETDATE(),
    RecipientName NVARCHAR(100),
    RecipientPhone NVARCHAR(20),
    RecipientAddress NVARCHAR(255),
    FOREIGN KEY (UserID) REFERENCES Users(UserID)
);

CREATE TABLE OrderDetails (
    OrderDetailID INT IDENTITY PRIMARY KEY,
    OrderID INT NOT NULL,
    ProductID INT NOT NULL,
    Quantity INT NOT NULL,
    UnitPrice DECIMAL(18,2) NOT NULL,
    FOREIGN KEY (OrderID) REFERENCES Orders(OrderID),
    FOREIGN KEY (ProductID) REFERENCES Products(ProductID)
);

CREATE TABLE OrderStatusHistory (
    HistoryID INT IDENTITY PRIMARY KEY,
    OrderID INT NOT NULL,
    Status NVARCHAR(50),
    UpdatedAt DATETIME DEFAULT GETDATE(),
    FOREIGN KEY (OrderID) REFERENCES Orders(OrderID)
);



/* ==========================
   USER INTERACTION
========================== */

CREATE TABLE Reviews (
    ReviewID INT IDENTITY PRIMARY KEY,
    UserID INT NOT NULL,
    ProductID INT NOT NULL,
    Rating INT CHECK(Rating BETWEEN 1 AND 5),
    Comment NVARCHAR(500),
    CreatedAt DATETIME DEFAULT GETDATE(),
    FOREIGN KEY (UserID) REFERENCES Users(UserID),
    FOREIGN KEY (ProductID) REFERENCES Products(ProductID)
);

CREATE TABLE Notifications (
    NotificationID INT IDENTITY PRIMARY KEY,
    UserID INT NOT NULL,
    Content NVARCHAR(255),
    IsRead BIT DEFAULT 0,
    CreatedAt DATETIME DEFAULT GETDATE(),
    FOREIGN KEY (UserID) REFERENCES Users(UserID)
);



/* ==========================
   VIEW THỐNG KÊ
========================== */
go
CREATE VIEW View_Statistics AS
SELECT 
    CONVERT(date, OrderDate) AS OrderDay,
    COUNT(OrderID) AS TotalOrders,
    SUM(TotalAmount) AS Revenue
FROM Orders
WHERE Status = N'Hoàn thành'
GROUP BY CONVERT(date, OrderDate);
GO


/* ==========================
   SAMPLE DATA
========================== */

-- Admin + Staff + Customer mẫu
INSERT INTO Users(Username, PasswordHash, FullName, Email) VALUES
(N'admin', N'123', N'Quản trị', N'admin@ifixzone.vn'),
(N'staff1', N'123', N'Nhân viên A', N'staff@ifixzone.vn'),
(N'user1', N'123', N'Nguyễn Văn A', N'user@gmail.com');

INSERT INTO UserRoles VALUES
(1,1),(2,2),(3,3);   -- admin / staff / customer

INSERT INTO Categories(CategoryName) VALUES
(N'Linh kiện điện thoại'),(N'Linh kiện laptop'),(N'Dụng cụ sửa chữa');

INSERT INTO Products(ProductName,CategoryID,Price,Stock,MainImage)
VALUES
(N'IC nguồn iPhone X',1,120000,50,'icx.jpg'),
(N'Pin laptop Dell 5480',2,850000,20,'pin5480.jpg'),
(N'Tua vít 24in1',3,180000,100,'tuvit.jpg');
GO
